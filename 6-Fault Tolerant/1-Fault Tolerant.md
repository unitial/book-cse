## 系统级容错

容错的方法是冗余。可以是时间上的冗余（如算两遍），也可以是空间上的冗余（如多台服务器）。

评价系统的容错能力，有两个指标：MTTF和Availability。MTTF越长越好，Availability的9的个数越多越好。

### MTTF：连续无故障运行时间

如何测量MTBF？通常是通过并行的方法，例如7000个硬盘连续运行1000小时，有10个故障，那么MTTF就是70万小时，也就是80年。这个结果显然并不符合直觉，因为我们知道硬盘的生命周期差不多是5年。那么80万小时这个值有什么意义呢？主要是指其“状态最好的时候”发生问题的可能，即浴盆曲线的最低处。

### Availability：可用性

如何测量Availability？通常根据历史数据。

### 系统级容错的四个方法

- **Coding**：编码，如“4,7汉明码”，可以纠正1-bit错，检测2-bit错
- **Replication**：复制（备份），坏了一个其他的备份可以补上
- **Voting**：投票，如三个备份同时运行，投票决定最后结果
- **Repair**：及时修复，通过少量冗余极大提高MTTF，例如车的备胎只需要1个而不是4个

### Case Study: 磁盘容错

常见错误包括：

- 写入数据时，硬件发生临时故障导致写错
- 数据在磁盘上，发生了bit反转
- 断电，导致数据没有写完，某个sector的数据一半新一半旧

容断电的方法：

- 每次写，将同样的数据写入3个sector，并保证写入的顺序为S1、S2、S3
- 每次读，读3个sector并进行比较，通过voting的方式，多数获胜；若无多数则取S1的数据，具体算法见书
- 这里也体现了All-or-nothing，当写到S2的时刻，之前是nothing，之后是all

### RAID

- RAID-0：把数据写到两个磁盘，不能容错（容错能力反而下降），能提高性能和容量
- RAID-1：同样的数据写到两个磁盘，容量为一个磁盘，能容一个磁盘的错；缺点是磁盘利用率只有50%
- RAID-4：N+1块磁盘，N块磁盘存数据，1块磁盘存校验码，能容一个磁盘的错；缺点是存校验码的磁盘负载过高
- RAID-5：N+1块磁盘，每块磁盘均保存校验码，彼此错开；解决了RAID-4中单一的校验码磁盘负载高的问题





