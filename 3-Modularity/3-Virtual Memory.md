## Virtual Memory

虚拟内存的目标是要为不同的program提供隔离的地址空间。一种简单的思路是对物理地址空间进行分区，让不同的program使用不同的分区。这种思路存在以下问题：物理地址空间不可扩展，所以program如果很多则分区可能不够用；一般来说分区是连续的，因此会出现碎片问题；对程序员不够友好，程序员可能需要考虑不同大小的分区问题；等等。

上述问题的根本原因，在于使用了物理地址空间。为解决该问题，我们引入一层新的indirection：虚拟地址空间，这也是一种新的naming机制。Name就是虚拟地址，value就是物理地址，两者通过页表实现映射，页表本身就是context。这是我们在ICS中学过的虚拟内存机制。

回顾一下：页表本身是树状结构，是CPU用来将VA翻译到PA的数据结构。理论上，页表应当完全存放在CPU内部；但CPU存不下，因为每个program都需要自己的页表，每个页表理论上是4MB（32位系统），所以页表只能保存在内存中；CPU上有一个寄存器，保存当前页表的地址（页目录，PTD），页目录（PT）指出去的是页表，页表中是页表项（PTE），每个页表项纪录一个物理页的地址。要注意的是，整个页表中所有纪录的数据都是物理地址。

对于一个页表项来说，只需要前20位记录一个4K的物理页，剩下12位用来记录其他信息，包括P位、R/W位、U/S位等。其中，U/S位的存在是为了说明该页是否只有内核才有权限访问，还是内核与应用都可以访问。这个位的存在是为了保护内核的数据不被应用程序访问，而最重要的数据结构之一就是页表本身；换句话说，页表本身在页表项中的U/S位设置为0。


